# Copyright 2025 ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

variables:
  VSIM: questa-2023.4 vsim
  BENDER: bender
  PYTHON: /usr/local/anaconda3/bin/python
  CHS_SW_GCC_BINROOT: /usr/pack/riscv-1.0-kgf/riscv64-gcc-12.2.0/bin
  LLVM_BINROOT: /usr/pack/riscv-1.0-kgf/pulp-llvm-0.12.0/bin

stages:
  - init
  - build
  - run

.cache-bender-deps:
  cache:
    key:
      files:
        - Bender.lock
    paths:
      - .bender/
      - .venv/

####################
# Pull bender deps #
####################

collect-bender-sources:
  stage: init
  extends: .cache-bender-deps
  script:
    - $BENDER checkout
  artifacts:
    paths:
      - .bender/

##############################
# Install python environment #
##############################

install-py-pkg:
  stage: init
  needs:
    - collect-bender-sources
  extends: .cache-bender-deps
  script:
    - $PYTHON -m venv .venv
    - source .venv/bin/activate
    - which python
    - which pip
    - python -m pip install $(bender path floo_noc)
    - python -m pip install $(bender path snitch_cluster)
  artifacts:
    paths:
      - .venv/

########################
# Build Software Tests #
########################

snrt-sw:
  stage: build
  needs:
    - collect-bender-sources
    - install-py-pkg
  script:
    - source .venv/bin/activate
    - which python
    - which pip
    - python -m pip list
    - make snrt-tests
  artifacts:
    paths:
      - sw/snitch/tests/build/*.elf
    expire_in: 1 day

chs-sw:
  stage: build
  needs:
    - collect-bender-sources
    - install-py-pkg
  script:
    - source .venv/bin/activate
    - which python
    - which pip
    - make chs-sw-tests
  artifacts:
    paths:
      - sw/cheshire/tests/*.elf
    expire_in: 1 day
